{"version":3,"file":"facet-filters-form.b49ef4e3.js","sources":["../frontend/components/facet-filters-form.js"],"sourcesContent":["import { debounce } from '@/lib/utils';\nimport { onKeyUpEscape } from '@/lib/a11y';\n\nclass FacetFiltersForm extends HTMLElement {\n  constructor() {\n    super();\n    this.onActiveFilterClick = this.onActiveFilterClick.bind(this);\n\n    this.debouncedOnSubmit = debounce((event) => {\n      this.onSubmitHandler(event);\n    }, 500);\n\n    const facetForm = this.querySelector('form');\n    facetForm.addEventListener('input', this.debouncedOnSubmit.bind(this));\n\n    const facetWrapper = this.querySelector('#FacetsWrapperDesktop');\n    if (facetWrapper) facetWrapper.addEventListener('keyup', onKeyUpEscape);\n  }\n\n  static setListeners() {\n    const onHistoryChange = (event) => {\n      const searchParams = event.state ? event.state.searchParams : FacetFiltersForm.searchParamsInitial;\n      if (searchParams === FacetFiltersForm.searchParamsPrev) return;\n      FacetFiltersForm.renderPage(searchParams, null, false);\n    }\n    window.addEventListener('popstate', onHistoryChange);\n  }\n\n  static toggleActiveFacets(disable = true) {\n    document.querySelectorAll('.js-facet-remove').forEach((element) => {\n      element.classList.toggle('disabled', disable);\n    });\n  }\n\n  static renderPage(searchParams, event, updateURLHash = true) {\n    FacetFiltersForm.searchParamsPrev = searchParams;\n    const sections = FacetFiltersForm.getSections();\n    const countContainer = document.getElementById('ProductCount');\n    const countContainerDesktop = document.getElementById('ProductCountDesktop');\n    document.getElementById('ProductGridContainer').querySelector('.collection').classList.add('loading');\n    if (countContainer){\n      countContainer.classList.add('loading');\n    }\n    if (countContainerDesktop){\n      countContainerDesktop.classList.add('loading');\n    }\n\n    sections.forEach((section) => {\n      const url = `${window.location.pathname}?section_id=${section.section}&${searchParams}`;\n      const filterDataUrl = element => element.url === url;\n\n      FacetFiltersForm.filterData.some(filterDataUrl) ?\n        FacetFiltersForm.renderSectionFromCache(filterDataUrl, event) :\n        FacetFiltersForm.renderSectionFromFetch(url, event);\n    });\n\n    if (updateURLHash) FacetFiltersForm.updateURLHash(searchParams);\n  }\n\n  static renderSectionFromFetch(url, event) {\n    fetch(url)\n      .then(response => response.text())\n      .then((responseText) => {\n        const html = responseText;\n        FacetFiltersForm.filterData = [...FacetFiltersForm.filterData, { html, url }];\n        FacetFiltersForm.renderFilters(html, event);\n        FacetFiltersForm.renderProductGridContainer(html);\n        FacetFiltersForm.renderProductCount(html);\n      });\n  }\n\n  static renderSectionFromCache(filterDataUrl, event) {\n    const html = FacetFiltersForm.filterData.find(filterDataUrl).html;\n    FacetFiltersForm.renderFilters(html, event);\n    FacetFiltersForm.renderProductGridContainer(html);\n    FacetFiltersForm.renderProductCount(html);\n  }\n\n  static renderProductGridContainer(html) {\n    document.getElementById('ProductGridContainer').innerHTML = new DOMParser().parseFromString(html, 'text/html').getElementById('ProductGridContainer').innerHTML;\n  }\n\n  static renderProductCount(html) {\n    const count = new DOMParser().parseFromString(html, 'text/html').getElementById('ProductCount').innerHTML\n    const container = document.getElementById('ProductCount');\n    const containerDesktop = document.getElementById('ProductCountDesktop');\n    container.innerHTML = count;\n    container.classList.remove('loading');\n    if (containerDesktop) {\n      containerDesktop.innerHTML = count;\n      containerDesktop.classList.remove('loading');\n    }\n  }\n\n  static renderFilters(html, event) {\n    const parsedHTML = new DOMParser().parseFromString(html, 'text/html');\n\n    const facetDetailsElements =\n      parsedHTML.querySelectorAll('#FacetFiltersForm .js-filter, #FacetFiltersFormMobile .js-filter, #FacetFiltersPillsForm .js-filter');\n    const matchesIndex = (element) => {\n      const jsFilter = event ? event.target.closest('.js-filter') : undefined;\n      return jsFilter ? element.dataset.index === jsFilter.dataset.index : false;\n    }\n    const facetsToRender = Array.from(facetDetailsElements).filter(element => !matchesIndex(element));\n    const countsToRender = Array.from(facetDetailsElements).find(matchesIndex);\n\n    facetsToRender.forEach((element) => {\n      document.querySelector(`.js-filter[data-index=\"${element.dataset.index}\"]`).innerHTML = element.innerHTML;\n    });\n\n    FacetFiltersForm.renderActiveFacets(parsedHTML);\n    FacetFiltersForm.renderAdditionalElements(parsedHTML);\n\n    if (countsToRender) FacetFiltersForm.renderCounts(countsToRender, event.target.closest('.js-filter'));\n  }\n\n  static renderActiveFacets(html) {\n    const activeFacetElementSelectors = ['.active-facets-mobile', '.active-facets-desktop'];\n\n    activeFacetElementSelectors.forEach((selector) => {\n      const activeFacetsElement = html.querySelector(selector);\n      if (!activeFacetsElement) return;\n      document.querySelector(selector).innerHTML = activeFacetsElement.innerHTML;\n    })\n\n    FacetFiltersForm.toggleActiveFacets(false);\n  }\n\n  static renderAdditionalElements(html) {\n    const mobileElementSelectors = ['.mobile-facets__open', '.mobile-facets__count', '.sorting'];\n\n    mobileElementSelectors.forEach((selector) => {\n      if (!html.querySelector(selector)) return;\n      document.querySelector(selector).innerHTML = html.querySelector(selector).innerHTML;\n    });\n\n    document.getElementById('FacetFiltersFormMobile').closest('menu-drawer').bindEvents();\n  }\n\n  static renderCounts(source, target) {\n    const targetElement = target.querySelector('.facets__selected');\n    const sourceElement = source.querySelector('.facets__selected');\n\n    const targetElementAccessibility = target.querySelector('.facets__summary');\n    const sourceElementAccessibility = source.querySelector('.facets__summary');\n\n    if (sourceElement && targetElement) {\n      target.querySelector('.facets__selected').outerHTML = source.querySelector('.facets__selected').outerHTML;\n    }\n\n    if (targetElementAccessibility && sourceElementAccessibility) {\n      target.querySelector('.facets__summary').outerHTML = source.querySelector('.facets__summary').outerHTML;\n    }\n  }\n\n  static updateURLHash(searchParams) {\n    history.pushState({ searchParams }, '', `${window.location.pathname}${searchParams && '?'.concat(searchParams)}`);\n  }\n\n  static getSections() {\n    return [\n      {\n        section: document.getElementById('product-grid').dataset.id,\n      }\n    ]\n  }\n\n  createSearchParams(form) {\n    const formData = new FormData(form);\n    return new URLSearchParams(formData).toString();\n  }\n\n  onSubmitForm(searchParams, event) {\n    FacetFiltersForm.renderPage(searchParams, event);\n  }\n\n  onSubmitHandler(event) {\n    event.preventDefault();\n    const sortFilterForms = document.querySelectorAll('facet-filters-form form');\n    if (event.srcElement.className == 'mobile-facets__checkbox') {\n      const searchParams = this.createSearchParams(event.target.closest('form'))\n      this.onSubmitForm(searchParams, event)\n    } else {\n      const forms = [];\n      const isMobile = event.target.closest('form').id === 'FacetFiltersFormMobile';\n\n      sortFilterForms.forEach((form) => {\n        if (!isMobile) {\n          if (form.id === 'FacetSortForm' || form.id === 'FacetFiltersForm' || form.id === 'FacetSortDrawerForm') {\n            forms.push(this.createSearchParams(form));\n          }\n        } else if (form.id === 'FacetFiltersFormMobile') {\n          forms.push(this.createSearchParams(form));\n        }\n      });\n      this.onSubmitForm(forms.join('&'), event)\n    }\n  }\n\n  onActiveFilterClick(event) {\n    event.preventDefault();\n    FacetFiltersForm.toggleActiveFacets();\n    const url = event.currentTarget.href.indexOf('?') == -1 ? '' : event.currentTarget.href.slice(event.currentTarget.href.indexOf('?') + 1);\n    FacetFiltersForm.renderPage(url);\n  }\n}\n\nFacetFiltersForm.filterData = [];\nFacetFiltersForm.searchParamsInitial = window.location.search.slice(1);\nFacetFiltersForm.searchParamsPrev = window.location.search.slice(1);\ncustomElements.define('facet-filters-form', FacetFiltersForm);\nFacetFiltersForm.setListeners();\n"],"names":[],"mappings":"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"}