{"version":3,"file":"predictive-search.82555d43.js","sources":["../frontend/components/predictive-search.js"],"sourcesContent":["import { debounce } from '@/lib/utils';\n\nclass PredictiveSearch extends HTMLElement {\n  constructor() {\n    super();\n    this.cachedResults = {};\n    this.input = this.querySelector('input[type=\"search\"]');\n    this.predictiveSearchResults = this.querySelector('[data-predictive-search]');\n    this.isOpen = false;\n\n    this.setupEventListeners();\n  }\n\n  setupEventListeners() {\n    const form = this.querySelector('form.search');\n    form.addEventListener('submit', this.onFormSubmit.bind(this));\n\n    this.input.addEventListener('input', debounce((event) => {\n      this.onChange(event);\n    }, 300).bind(this));\n    this.input.addEventListener('focus', this.onFocus.bind(this));\n    this.addEventListener('focusout', this.onFocusOut.bind(this));\n    this.addEventListener('keyup', this.onKeyup.bind(this));\n    this.addEventListener('keydown', this.onKeydown.bind(this));\n  }\n\n  getQuery() {\n    return this.input.value.trim();\n  }\n\n  onChange() {\n    const searchTerm = this.getQuery();\n\n    if (!searchTerm.length) {\n      this.close(true);\n      return;\n    }\n\n    this.getSearchResults(searchTerm);\n  }\n\n  onFormSubmit(event) {\n    if (!this.getQuery().length || this.querySelector('[aria-selected=\"true\"] a')) event.preventDefault();\n  }\n\n  onFocus() {\n    const searchTerm = this.getQuery();\n\n    if (!searchTerm.length) return;\n\n    if (this.getAttribute('results') === 'true') {\n      this.open();\n    } else {\n      this.getSearchResults(searchTerm);\n    }\n  }\n\n  onFocusOut() {\n    setTimeout(() => {\n      if (!this.contains(document.activeElement)) this.close();\n    })\n  }\n\n  onKeyup(event) {\n    if (!this.getQuery().length) this.close(true);\n    event.preventDefault();\n\n    switch (event.code) {\n      case 'ArrowUp':\n        this.switchOption('up')\n        break;\n      case 'ArrowDown':\n        this.switchOption('down');\n        break;\n      case 'Enter':\n        this.selectOption();\n        break;\n    }\n  }\n\n  onKeydown(event) {\n    // Prevent the cursor from moving in the input when using the up and down arrow keys\n    if (\n      event.code === 'ArrowUp' ||\n      event.code === 'ArrowDown'\n    ) {\n      event.preventDefault();\n    }\n  }\n\n  switchOption(direction) {\n    if (!this.getAttribute('open')) return;\n\n    const moveUp = direction === 'up';\n    const selectedElement = this.querySelector('[aria-selected=\"true\"]');\n    const allElements = this.querySelectorAll('li');\n    let activeElement = this.querySelector('li');\n\n    if (moveUp && !selectedElement) return;\n\n    this.statusElement.textContent = '';\n\n    if (!moveUp && selectedElement) {\n      activeElement = selectedElement.nextElementSibling || allElements[0];\n    } else if (moveUp) {\n      activeElement = selectedElement.previousElementSibling || allElements[allElements.length - 1];\n    }\n\n    if (activeElement === selectedElement) return;\n\n    activeElement.setAttribute('aria-selected', true);\n    if (selectedElement) selectedElement.setAttribute('aria-selected', false);\n\n    this.setLiveRegionText(activeElement.textContent);\n    this.input.setAttribute('aria-activedescendant', activeElement.id);\n  }\n\n  selectOption() {\n    const selectedProduct = this.querySelector('[aria-selected=\"true\"] a, [aria-selected=\"true\"] button');\n\n    if (selectedProduct) selectedProduct.click();\n  }\n\n  getSearchResults(searchTerm) {\n    const queryKey = searchTerm.replace(\" \", \"-\").toLowerCase();\n    this.setLiveRegionLoadingState();\n\n    if (this.cachedResults[queryKey]) {\n      this.renderSearchResults(this.cachedResults[queryKey]);\n      return;\n    }\n\n    fetch(`${routes.predictive_search_url}?q=${encodeURIComponent(searchTerm)}&${encodeURIComponent('resources[type]')}=product&${encodeURIComponent('resources[limit]')}=4&section_id=predictive-search`)\n      .then((response) => {\n        if (!response.ok) {\n          var error = new Error(response.status);\n          this.close();\n          throw error;\n        }\n\n        return response.text();\n      })\n      .then((text) => {\n        const resultsMarkup = new DOMParser().parseFromString(text, 'text/html').querySelector('#shopify-section-predictive-search').innerHTML;\n        this.cachedResults[queryKey] = resultsMarkup;\n        this.renderSearchResults(resultsMarkup);\n      })\n      .catch((error) => {\n        this.close();\n        throw error;\n      });\n  }\n\n  setLiveRegionLoadingState() {\n    this.statusElement = this.statusElement || this.querySelector('.predictive-search-status');\n    this.loadingText = this.loadingText || this.getAttribute('data-loading-text');\n\n    this.setLiveRegionText(this.loadingText);\n    this.setAttribute('loading', true);\n  }\n\n  setLiveRegionText(statusText) {\n    this.statusElement.setAttribute('aria-hidden', 'false');\n    this.statusElement.textContent = statusText;\n\n    setTimeout(() => {\n      this.statusElement.setAttribute('aria-hidden', 'true');\n    }, 1000);\n  }\n\n  renderSearchResults(resultsMarkup) {\n    this.predictiveSearchResults.innerHTML = resultsMarkup;\n    this.setAttribute('results', true);\n\n    this.setLiveRegionResults();\n    this.open();\n  }\n\n  setLiveRegionResults() {\n    this.removeAttribute('loading');\n    this.setLiveRegionText(this.querySelector('[data-predictive-search-live-region-count-value]').textContent);\n  }\n\n  getResultsMaxHeight() {\n    this.resultsMaxHeight = window.innerHeight - document.getElementById('shopify-section-header').getBoundingClientRect().bottom;\n    return this.resultsMaxHeight;\n  }\n\n  open() {\n    this.predictiveSearchResults.style.maxHeight = this.resultsMaxHeight || `${this.getResultsMaxHeight()}px`;\n    this.setAttribute('open', true);\n    this.input.setAttribute('aria-expanded', true);\n    this.isOpen = true;\n  }\n\n  close(clearSearchTerm = false) {\n    if (clearSearchTerm) {\n      this.input.value = '';\n      this.removeAttribute('results');\n    }\n\n    const selected = this.querySelector('[aria-selected=\"true\"]');\n\n    if (selected) selected.setAttribute('aria-selected', false);\n\n    this.input.setAttribute('aria-activedescendant', '');\n    this.removeAttribute('open');\n    this.input.setAttribute('aria-expanded', false);\n    this.resultsMaxHeight = false\n    this.predictiveSearchResults.removeAttribute('style');\n\n    this.isOpen = false;\n  }\n}\n\ncustomElements.define('predictive-search', PredictiveSearch);\n"],"names":[],"mappings":"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"}